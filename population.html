<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Top Two Most Spoken Languages by Area</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- DataTables Bootstrap CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    h1 {
      color: #343a40;
    }
    .table {
      background-color: #fff;
      border-radius: 5px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      background-color: #007bff !important;
      color: white !important;
      border: none;
      border-radius: 4px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background-color: #0056b3 !important;
      color: white !important;
    }
    /* Loader styles */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Disabled anchor styling */
    a.disabled {
      pointer-events: none;
      opacity: 0.6;
    }
    /* Multi-select styling */
    #areaFilter {
      width: auto;
      display: inline-block;
    }
    /* Cursor pointer for clickable area name */
    .area-info {
      cursor: pointer;
      text-decoration: underline;
      color: #007bff;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <div class="container my-4">
    <h1 class="mb-4 text-center">Top Two Most Spoken Languages by Area</h1>
    <div class="mb-3 text-center">
      <div class="form-group">
        <label for="areaFilter"><strong>Select Area Types:</strong></label>
        <select id="areaFilter" class="form-control" multiple>
          <option value="State">State</option>
          <option value="District">District</option>
          <option value="Subdistrict" selected>Subdistrict</option>
        </select>
      </div>
      <button id="downloadJson" class="btn btn-primary mr-2">Download Table as JSON</button>
      <a id="downloadExcel" href="DDW-C16-STMT-MDDS-2100.XLSX" download class="btn btn-secondary">Download Original Excel</a>
    </div>
    <div class="table-responsive">
      <table id="resultTable" class="table table-bordered table-striped table-hover">
         <thead class="thead-dark">
           <tr>
              <th>Area</th>
              <th>Population</th>
              <th>Languages Count</th>
              <th>First Language (L1)</th>
              <th>L1#</th>
              <th>L1%</th>
              <th>Second Language (L2)</th>
              <th>L2#</th>
              <th>L2%</th>
           </tr>
         </thead>
         <tbody>
         </tbody>
      </table>
    </div>
  </div>

  <!-- Modal for Area Details -->
  <div class="modal fade" id="areaModal" tabindex="-1" role="dialog" aria-labelledby="areaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="areaModalLabel">Area Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="modal-body">
           <p><strong>Area Name:</strong> <span id="modalAreaName"></span></p>
           <p><strong>Area Type:</strong> <span id="modalAreaType"></span></p>
           <p><strong>State Name:</strong> <span id="modalStateName"></span></p>
           <p><strong>District Name:</strong> <span id="modalDistrictName"></span></p>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
  <!-- SheetJS for Excel reading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    $(document).ready(function() {
      // Initially disable buttons
      $("#downloadJson").prop("disabled", true);
      $("#downloadExcel").addClass("disabled");

      // Show loader
      $("#loader").show();

      // Global variables for table data
      var allTableData = [];
      var filteredTableData = [];
      
      // Mapping objects for names (from codes)
      var stateMapping = {};    // key: state code (col B), value: state name (col E) for State rows
      var districtMapping = {}; // key: district code (col C), value: district name (col E) for District rows

      // Function to initialize DataTable with pagination size 20
      function initializeDataTable() {
        $("#resultTable").DataTable({
          "order": [[ 1, "desc" ]], // Default sort: Population descending
          "pageLength": 20,
          "columnDefs": [
            { "type": "num", "targets": [1, 2, 4, 7, 8] }
          ]
        });
      }

      // Function to populate the table based on the selected filter types
      function populateTable(filterTypes) {
        // If DataTable is already initialized, destroy it first.
        if ($.fn.DataTable.isDataTable('#resultTable')) {
          $('#resultTable').DataTable().destroy();
        }
        // Empty the table body.
        $("#resultTable tbody").empty();
        // Filter the data.
        filteredTableData = allTableData.filter(function(item) {
          return filterTypes.indexOf(item.type) !== -1;
        });
        // Append rows for each filtered item. The area name is now a clickable link.
        filteredTableData.forEach(function(item, index) {
          var rowHtml = "<tr>" +
            "<td><a href='#' class='area-info' data-index='" + index + "'>" + item.area + "</a></td>" +
            "<td>" + item.population + "</td>" +
            "<td>" + item.languagesCount + "</td>" +
            "<td>" + item.L1 + "</td>" +
            "<td>" + item.L1Count + "</td>" +
            "<td>" + item.L1Percent + "%</td>" +
            "<td>" + item.L2 + "</td>" +
            "<td>" + item.L2Count + "</td>" +
            "<td>" + item.L2Percent + "%</td>" +
            "</tr>";
          $("#resultTable tbody").append(rowHtml);
        });
        // Reinitialize DataTable.
        initializeDataTable();
      }

      // Path to the Excel file (it must be in the same folder)
      var url = "DDW-C16-STMT-MDDS-2100.XLSX";
      var oReq = new XMLHttpRequest();
      oReq.open("GET", url, true);
      oReq.responseType = "arraybuffer";
      oReq.onload = function(e) {
         var arraybuffer = oReq.response;
         var data = new Uint8Array(arraybuffer);
         // Read the workbook
         var workbook = XLSX.read(data, {type:"array"});
         var firstSheetName = workbook.SheetNames[0];
         var worksheet = workbook.Sheets[firstSheetName];
         // Convert the sheet to JSON with rows as arrays.
         var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
         
         // Object to group rows by area name.
         var results = {}; 
         // Process rows (assume the first row is header, so start at index 1).
         for (var i = 1; i < jsonData.length; i++) {
           var row = jsonData[i];
           // Expected columns:
           // Column B (index 1): State Code
           // Column C (index 2): District Code
           // Column D (index 3): Subdistrict Code
           // Column E (index 4): Area Name
           // Column G (index 6): Mother Tongue (with a numeric prefix)
           // Column H (index 7): Count
           var stateCode = row[1] || "";
           var districtCode = row[2] ? row[2].toString() : "";
           var subdistrictCode = row[3] ? row[3].toString() : "";
           var areaName = row[4];
           var languageRaw = row[6];
           var count = parseInt(row[7]) || 0;
           
           if (!areaName || !languageRaw) continue;
           
           // Determine area type:
           // - State: District Code == "000" and Subdistrict Code == "00000"
           // - District: Subdistrict Code == "00000" (but not State)
           // - Subdistrict: otherwise.
           var areaType = "";
           if(districtCode === "000" && subdistrictCode === "00000") {
             areaType = "State";
           } else if(subdistrictCode === "00000") {
             areaType = "District";
           } else {
             areaType = "Subdistrict";
           }
           
           // Build mapping for names:
           if(areaType === "State") {
             // For state rows, areaName holds the state name.
             stateMapping[stateCode] = areaName;
           } else if(areaType === "District") {
             // For district rows, areaName holds the district name.
             districtMapping[districtCode] = areaName;
           }
           
           // Only include rows where language starts with a digit and does not include "Others"
           if (!/^\d/.test(languageRaw) || languageRaw.toLowerCase().indexOf("others") !== -1) {
             continue;
           }
           
           // Remove the number prefix. E.g., "1 Assamese" becomes "Assamese".
           var langMatch = languageRaw.match(/^\d+\s+(.*)/);
           var language = langMatch ? langMatch[1].trim() : languageRaw.trim();
           
           // Initialize grouping for this area if it doesn't exist.
           if (!results[areaName]) {
             results[areaName] = {
                totalPopulation: 0,
                languages: {},
                type: areaType,
                stateCode: stateCode,
                districtCode: districtCode
             };
           }
           // Add count to total population and to the language-specific total.
           results[areaName].totalPopulation += count;
           if (results[areaName].languages[language]) {
             results[areaName].languages[language] += count;
           } else {
             results[areaName].languages[language] = count;
           }
         }
         
         // Prepare the final table data array.
         allTableData = [];
         for (var area in results) {
           var areaData = results[area];
           var totalPopulation = areaData.totalPopulation;
           var languages = areaData.languages;
           var languagesCount = Object.keys(languages).length;
           
           // Sort the languages by their count in descending order.
           var sortedLang = Object.keys(languages).sort(function(a, b) {
             return languages[b] - languages[a];
           });
           
           var L1 = sortedLang[0] || "";
           var L1Count = languages[L1] || 0;
           var L1Percent = totalPopulation ? ((L1Count / totalPopulation) * 100).toFixed(2) : "0.00";
           
           var L2 = sortedLang[1] || "";
           var L2Count = languages[L2] || 0;
           var L2Percent = totalPopulation ? ((L2Count / totalPopulation) * 100).toFixed(2) : "0.00";
           
           // Determine proper names for the modal based on area type.
           var dispStateName = "";
           var dispDistrictName = "";
           if(areaData.type === "State") {
             // For state rows, the area name is the state name.
             dispStateName = area;
             dispDistrictName = "N/A";
           } else if(areaData.type === "District") {
             // For district rows, use the state mapping for the state name.
             dispStateName = stateMapping[areaData.stateCode] || areaData.stateCode;
             dispDistrictName = area; // Area name holds district name.
           } else {
             // For subdistrict rows, look up both state and district names.
             dispStateName = stateMapping[areaData.stateCode] || areaData.stateCode;
             dispDistrictName = districtMapping[areaData.districtCode] || areaData.districtCode;
           }
           
           allTableData.push({
             area: area,
             population: totalPopulation,
             languagesCount: languagesCount,
             L1: L1,
             L1Count: L1Count,
             L1Percent: L1Percent,
             L2: L2,
             L2Count: L2Count,
             L2Percent: L2Percent,
             type: areaData.type,
             stateName: dispStateName,
             districtName: dispDistrictName
           });
         }
         
         // Initially populate table with default filter: only Subdistrict
         populateTable(["Subdistrict"]);
         
         // Bind change event on multi-select field.
         $("#areaFilter").change(function() {
           var selected = $(this).val() || [];
           populateTable(selected);
         });
         
         // Hide loader and re-enable buttons
         $("#loader").fadeOut();
         $("#downloadJson").prop("disabled", false);
         $("#downloadExcel").removeClass("disabled");
         
         // When the "Download JSON" button is clicked, export the currently displayed table data as JSON.
         $("#downloadJson").click(function() {
           var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredTableData, null, 2));
           var downloadAnchorNode = document.createElement('a');
           downloadAnchorNode.setAttribute("href", dataStr);
           downloadAnchorNode.setAttribute("download", "tableData.json");
           document.body.appendChild(downloadAnchorNode);
           downloadAnchorNode.click();
           downloadAnchorNode.remove();
         });
      };
      oReq.send();
      
      // When an area name is clicked, show the modal with details.
      $(document).on("click", ".area-info", function(e) {
        e.preventDefault();
        var index = $(this).data("index");
        var item = filteredTableData[index];
        $("#modalAreaName").text(item.area);
        $("#modalAreaType").text(item.type);
        $("#modalStateName").text(item.stateName);
        $("#modalDistrictName").text(item.districtName);
        $("#areaModal").modal("show");
      });
    });
  </script>
</body>
</html>