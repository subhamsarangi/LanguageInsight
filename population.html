<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Top Two Most Spoken Languages by Area</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- DataTables Bootstrap CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    h1 {
      color: #343a40;
    }
    .table {
      background-color: #fff;
      border-radius: 5px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      background-color: #007bff !important;
      color: white !important;
      border: none;
      border-radius: 4px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background-color: #0056b3 !important;
      color: white !important;
    }
    /* Loader styles */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Disabled anchor styling */
    a.disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>

  <div class="container my-4">
    <h1 class="mb-4 text-center">Top Two Most Spoken Languages by Area</h1>
    <div class="mb-3 text-center">
      <button id="downloadJson" class="btn btn-primary mr-2">Download Table as JSON</button>
      <a id="downloadExcel" href="DDW-C16-STMT-MDDS-2100.XLSX" download class="btn btn-secondary">Download Original Excel</a>
    </div>
    <div class="table-responsive">
      <table id="resultTable" class="table table-bordered table-striped table-hover">
         <thead class="thead-dark">
           <tr>
              <th>Area</th>
              <th>Population</th>
              <th>Languages Count</th>
              <th>First Language (L1)</th>
              <th>L1#</th>
              <th>L1%</th>
              <th>Second Language (L2)</th>
              <th>L2#</th>
              <th>L2%</th>
           </tr>
         </thead>
         <tbody>
         </tbody>
      </table>
    </div>
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
  <!-- SheetJS for Excel reading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    $(document).ready(function() {
      // Initially disable buttons
      $("#downloadJson").prop("disabled", true);
      $("#downloadExcel").addClass("disabled");

      // Show loader
      $("#loader").show();

      // Function to initialize DataTable after data load
      function initializeDataTable() {
        $("#resultTable").DataTable({
          "order": [[ 1, "desc" ]], // Default sort: Population descending
          "columnDefs": [
            { "type": "num", "targets": [1, 2, 4, 7, 8] }
          ]
        });
      }

      // Path to the Excel file (it must be in the same folder)
      var url = "DDW-C16-STMT-MDDS-2100.XLSX";
      var oReq = new XMLHttpRequest();
      oReq.open("GET", url, true);
      oReq.responseType = "arraybuffer";
      oReq.onload = function(e) {
         var arraybuffer = oReq.response;
         var data = new Uint8Array(arraybuffer);
         // Read the workbook
         var workbook = XLSX.read(data, {type:"array"});
         var firstSheetName = workbook.SheetNames[0];
         var worksheet = workbook.Sheets[firstSheetName];
         // Convert the sheet to JSON with rows as arrays.
         var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
         
         // Initialize a grouping object by area.
         var results = {}; 
         // Assume the first row is header, so data starts at index 1.
         for (var i = 1; i < jsonData.length; i++) {
           var row = jsonData[i];
           // Column indexes: area: column E (index 4), mother tongue: column G (index 6), count: column H (index 7)
           var area = row[4];
           var languageRaw = row[6];
           var count = parseInt(row[7]) || 0;
           
           if (!area || !languageRaw) continue;
           
           // Only include rows where language starts with a digit and does not include "Others"
           if (!/^\d/.test(languageRaw) || languageRaw.toLowerCase().indexOf("others") !== -1) {
             continue;
           }
           
           // Remove the number prefix. For example, "1 Assamese" becomes "Assamese".
           var langMatch = languageRaw.match(/^\d+\s+(.*)/);
           var language = langMatch ? langMatch[1].trim() : languageRaw.trim();
           
           // Initialize the area entry if it does not exist.
           if (!results[area]) {
             results[area] = {
                totalPopulation: 0,
                languages: {}
             };
           }
           // Sum the total population for the area.
           results[area].totalPopulation += count;
           // Sum the count for the given language in that area.
           if (results[area].languages[language]) {
             results[area].languages[language] += count;
           } else {
             results[area].languages[language] = count;
           }
         }
         
         // Prepare the final table data array.
         var tableData = [];
         for (var area in results) {
           var areaData = results[area];
           var totalPopulation = areaData.totalPopulation;
           var languages = areaData.languages;
           var languagesCount = Object.keys(languages).length;
           
           // Sort the languages by their count in descending order.
           var sortedLang = Object.keys(languages).sort(function(a, b) {
             return languages[b] - languages[a];
           });
           
           var L1 = sortedLang[0] || "";
           var L1Count = languages[L1] || 0;
           var L1Percent = totalPopulation ? ((L1Count / totalPopulation) * 100).toFixed(2) : "0.00";
           
           var L2 = sortedLang[1] || "";
           var L2Count = languages[L2] || 0;
           var L2Percent = totalPopulation ? ((L2Count / totalPopulation) * 100).toFixed(2) : "0.00";
           
           tableData.push({
             area: area,
             population: totalPopulation,
             languagesCount: languagesCount,
             L1: L1,
             L1Count: L1Count,
             L1Percent: L1Percent,
             L2: L2,
             L2Count: L2Count,
             L2Percent: L2Percent
           });
         }
         
         // Populate the HTML table with the calculated data.
         var tbody = $("#resultTable tbody");
         tableData.forEach(function(item) {
           var rowHtml = "<tr>" +
             "<td>" + item.area + "</td>" +
             "<td>" + item.population + "</td>" +
             "<td>" + item.languagesCount + "</td>" +
             "<td>" + item.L1 + "</td>" +
             "<td>" + item.L1Count + "</td>" +
             "<td>" + item.L1Percent + "%</td>" +
             "<td>" + item.L2 + "</td>" +
             "<td>" + item.L2Count + "</td>" +
             "<td>" + item.L2Percent + "%</td>" +
             "</tr>";
           tbody.append(rowHtml);
         });
         
         // Initialize DataTable for sortable functionality
         initializeDataTable();
         
         // Hide loader and re-enable buttons
         $("#loader").fadeOut();
         $("#downloadJson").prop("disabled", false);
         $("#downloadExcel").removeClass("disabled");
         
         // When the "Download JSON" button is clicked, export the table data as a JSON file.
         $("#downloadJson").click(function() {
           var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tableData, null, 2));
           var downloadAnchorNode = document.createElement('a');
           downloadAnchorNode.setAttribute("href", dataStr);
           downloadAnchorNode.setAttribute("download", "tableData.json");
           document.body.appendChild(downloadAnchorNode);
           downloadAnchorNode.click();
           downloadAnchorNode.remove();
         });
      };
      oReq.send();
    });
  </script>
</body>
</html>